 <!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

  <link rel="stylesheet"    href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />

    <title>Monitor_NS!</title>
  </head>
  <body>
    <div class="container">
      <h1>ARG</h1>

      <form action="#" onsubmit="consultar();">
        <div class="form-group">
          <label for="input_URL">URL</label>
          <input type="text" class="form-control" id="input_URL" aria-describedby="emailHelp" placeholder="URL de nightscout" value="http://localhost:1337/api/v1/treatments.json">
        </div>

        <div class="row">
          <div class="col">
            <input type="text" id="input_fromDate" class="form-control" placeholder="UNIX Time(en ms) desde cuando (por defecto hace un dia)" value="">
          </div>
          <div class="col">
            <input type="text" id="input_toDate" class="form-control" placeholder="UNIX Time(en ms) hasta cuando (por defecto ahora)" value="">
          </div>
        </div>

        <br>
        <button type="submit" class="btn btn-primary">Consultar</button>
      </form>
        <br>
      <h2>Resultado:</h2>
        <br>
      <div id="datosNightscout">
        <div id="exTab1" class="container"> 
          <ul id="tab-group" class="nav nav-pills">

          </ul>
        </div>


        <div class="tab-content clearfix" id="tab-group-content">
          
        </div>
      </div>
  </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.js" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    
    <script>

    var tabGroupsType = [];
    var tables = [];

    function convertirTiempo(tiempo){
      var unixTimeMs = tiempo;

      if (unixTimeMs < 1923264000) {
        unixTimeMs= unixTimeMs * 1000;
      }
      var d = new Date(unixTimeMs);
      var timeStr = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();

      return tiempo + " | " + timeStr;
    }


    function procesarCabecera(data){
      var tabs=[];

      for (var i of data){
        if (i.eventType == "ARG History"){
          var type = i.type;

          if (type !== undefined){
            var existType = false;

            var row  = JSON.parse(i.reason);
            var row_header = new Set(Object.keys(row));

            if (row.time !== undefined)
              row.time = convertirTiempo(row.time);

            type = type.replace("Biometrics.", "BIOMETRICS_");
            
            for (var tab = 0; tab < tabs.length; tab++){
              if (tabs[tab].type == type){
                var setC1 = new Set( [ ...row_header ].filter( x => ! tabs[tab].headers.has( x ) ) );
                var setC2 = new Set( [ ...tabs[tab].headers ].filter( x => ! row_header.has( x ) ) );
                
                if (setC1.size == 0 && setC2.size == 0){
                  existType = true;
                  break;
                }else{
                 // console.log("diff", setC);
                }
              }
            }

            //console.log(row_header);

            if (!existType){
              tab = tabs.length;
              tabs.push({type: type, data:[Object.values(row)], headers: new Set(row_header)});
            }else{
              if (row_header.length != tabs[tab].headers.length){
                console.log("Agregar row imposible", row_header, tabs[tab].headers  );
              }else{
                tabs[tab].data.push(Object.values(row));
              }

            }
          }

        }
      }

      return tabs;

      console.log("procesarCabecera -> ", tabs);
    }

    function consultar(){
      var to = new Date().getTime();
      var from = to - 3600000000;

      var input_URL = $("#input_URL").val();
      var input_fromDate = parseInt($("#input_fromDate").val());
      var input_toDate = parseInt($("#input_toDate").val());

      if (input_fromDate > 0)
        from = input_fromDate;

      if (input_toDate > 0)
        to = input_toDate;

      var tquery = '?find[created_at][$gte]='+new Date(from).toISOString()+'&find[created_at][$lt]='+new Date(to).toISOString();

      $("#tab-group-content").html("");
      $("#tab-group").html("");
      
      $.ajax({
          url:input_URL+tquery,
          type:'GET',
          success: function (result) {    
            var head = false;
            var table;
            var headers = [];

            var tabs = procesarCabecera(result);

            console.log(tabs);

            for (var tab = 0; tab < tabs.length;tab++){
              var groupid = tab;

              $("#tab-group").append("<li class=\"nav-item\"> <a href=\"#group" + groupid + "\" data-toggle=\"tab\" class=\"nav-link\">" + tabs[tab].type + "_" + groupid + "</a></li>");

              var tableHtml = "<table id=\"" + tabs[tab].type  + "_" + groupid + "\" class=\"display\" style=\"width:100%\"><thead><tr>";
              for (var it = tabs[tab].headers.values(), val= null; val=it.next().value; ) {
                tableHtml += '<td>' + val + '</td>';
              }
              tableHtml += "</tr></thead><tbody></tbody></table>";

              $("#tab-group-content").append("<div class=\"tab-pane\" id=\"group" + groupid + "\">" + tableHtml + "</div>");

              var newTable = $('#' + tabs[tab].type + "_" + groupid).DataTable({
                  "order": [[ 0, "desc" ]],
                  "data": tabs[tab].data
              });
            }
            return;
          }
        });
    }

    $(document).ready(function(){
      consultar();  
    });
    </script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js"></script>

  </body>
</html>
